@implements IAsyncDisposable
@inject IJSRuntime _jsRuntime

<section class="video_container">
    @if (controls)
    {
        <video src="@(src ?? _videoPlaceHolder)" controls playsinline preload="none">
            <img src="@(fallbackImage ?? _imagePlaceHolder)" title="Your browser does not support the <video> tag" />
        </video>
    }
    else
    {
        <video id="@_uniqueVideoPlayerId" src="@(src ?? _videoPlaceHolder)" playsinline loop=@loop muted=@(muted || autoplay) autoplay=@autoplay>
            <img src="@(fallbackImage ?? _imagePlaceHolder)" title="Your browser does not support the <video> tag" />
        </video>
    }
</section>

@code {
    [Parameter]
    [EditorRequired]
    public string? src { get; set; }

    [Parameter]
    public bool autoplay { get; set; } = false;

    [Parameter]
    public bool loop { get; set; } = false;

    [Parameter]
    public bool muted { get; set; } = false;

    [Parameter]
    public bool controls { get; set; } = false;

    [Parameter]
    public string? fallbackImage { get; set; }

    private readonly string _uniqueVideoPlayerId = Guid.NewGuid().ToString();
    private readonly string _videoPlaceHolder = "./_content/NativoPlus.BlazorRCL/placeholder.mp4";
    private readonly string _imagePlaceHolder = "./_content/NativoPlus.BlazorRCL/placeholder.png";

    private IJSObjectReference? _module;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await _jsRuntime.InvokeAsync<IJSObjectReference>("import",
                "./_content/NativoPlus.BlazorRCL/Nativo-Video.razor.js");

            if (muted || autoplay)
                await _jsRuntime.InvokeVoidAsync("helperFunctions.muteVideo", _uniqueVideoPlayerId);

            if (autoplay)
                await _jsRuntime.InvokeVoidAsync("helperFunctions.playVideo", _uniqueVideoPlayerId);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            await _module.DisposeAsync();
        }
    }
}
